
#include "../include/chat.h"

// æœåŠ¡å™¨é…ç½®
#define SERVER_IP "120.46.90.109"  // ä¿®æ”¹ä¸ºæ‚¨çš„å…¬ç½‘æœåŠ¡å™¨IP
#define SERVER_PORT 8888

int main() {
    // è®¾ç½®æ§åˆ¶å°ä»£ç é¡µä¸º UTF-8
    SetConsoleOutputCP(65001);
    
    printf("=== Socketé€šä¿¡å®¢æˆ·ç«¯ ===\n");
    printf("ç‰ˆæœ¬: 1.0\n");
    printf("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...\n\n");
    
    // åˆå§‹åŒ–Winsock
    init_winsock();
    
    // åˆ›å»ºå®¢æˆ·ç«¯Socket
    SOCKET client_socket = socket(AF_INET, SOCK_STREAM, 0);
    if (client_socket == INVALID_SOCKET) {
        printf("åˆ›å»ºSocketå¤±è´¥: %d\n", WSAGetLastError());
        cleanup_winsock();
        return 1;
    }
    
    // é…ç½®æœåŠ¡å™¨åœ°å€
    struct sockaddr_in server_addr;
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = inet_addr(SERVER_IP);  // ä½¿ç”¨é…ç½®çš„æœåŠ¡å™¨IP
    server_addr.sin_port = htons(SERVER_PORT);
    
    // è¿æ¥åˆ°æœåŠ¡å™¨
    printf("æ­£åœ¨è¿æ¥åˆ° %s:%d...\n", SERVER_IP, SERVER_PORT);
    if (connect(client_socket, (struct sockaddr*)&server_addr, sizeof(server_addr)) == SOCKET_ERROR) {
        printf("âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥: %d\n", WSAGetLastError());
        printf("è¯·ç¡®ä¿:\n");
        printf("1. æœåŠ¡å™¨ç¨‹åºæ­£åœ¨è¿è¡Œ\n");
        printf("2. é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢è¿æ¥\n");
        printf("3. ç«¯å£ %d æ²¡æœ‰è¢«å…¶ä»–ç¨‹åºå ç”¨\n", SERVER_PORT);
        closesocket(client_socket);
        cleanup_winsock();
        system("pause");
        return 1;
    }
    
    printf("âœ“ æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨ï¼\n\n");
    
    // è·å–ç”¨æˆ·æ˜µç§°
    char username[NAME_SIZE];
    printf("è¯·è¾“å…¥æ‚¨çš„æ˜µç§° (æœ€å¤š%dä¸ªå­—ç¬¦): ", NAME_SIZE - 1);
    fflush(stdout);
    
    if (fgets(username, sizeof(username), stdin) == NULL) {
        printf("è¯»å–æ˜µç§°å¤±è´¥\n");
        closesocket(client_socket);
        cleanup_winsock();
        return 1;
    }
    
    // ç§»é™¤æ¢è¡Œç¬¦
    username[strcspn(username, "\n")] = '\0';
    
    // æ£€æŸ¥æ˜µç§°æ˜¯å¦ä¸ºç©º
    if (strlen(username) == 0) {
        printf("æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ˜µç§°: åŒ¿åç”¨æˆ·\n");
        strcpy(username, "åŒ¿åç”¨æˆ·");
    }
    
    // å‘é€ç™»å½•æ¶ˆæ¯
    Message login_msg;
    memset(&login_msg, 0, sizeof(login_msg));
    login_msg.type = MSG_LOGIN;
    strncpy(login_msg.sender, username, NAME_SIZE - 1);
    strncpy(login_msg.content, "ç”¨æˆ·ç™»å½•", BUFFER_SIZE - 1);
    strncpy(login_msg.timestamp, get_current_time(), 31);
    
    if (send(client_socket, (char*)&login_msg, sizeof(Message), 0) == SOCKET_ERROR) {
        printf("å‘é€ç™»å½•æ¶ˆæ¯å¤±è´¥: %d\n", WSAGetLastError());
        closesocket(client_socket);
        cleanup_winsock();
        return 1;
    }
    
    printf("âœ“ ç™»å½•æˆåŠŸï¼æ¬¢è¿ [%s]\n", username);
    printf("\n=== èŠå¤©å®¤ä½¿ç”¨è¯´æ˜ ===\n");
    printf("â€¢ ç›´æ¥è¾“å…¥æ¶ˆæ¯å¹¶æŒ‰å›è½¦å‘é€\n");
    printf("â€¢ è¾“å…¥ 'quit' æˆ– 'exit' é€€å‡ºç¨‹åº\n");
    printf("â€¢ è¾“å…¥ 'help' æŸ¥çœ‹å¸®åŠ©\n");
    printf("========================\n\n");
    
    // åˆ›å»ºæ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹
    HANDLE recv_thread = CreateThread(NULL, 0, receive_messages, (LPVOID)client_socket, 0, NULL);
    if (recv_thread == NULL) {
        printf("åˆ›å»ºæ¥æ”¶çº¿ç¨‹å¤±è´¥\n");
        closesocket(client_socket);
        cleanup_winsock();
        return 1;
    }
    
    // ä¸»å¾ªç¯ - å‘é€æ¶ˆæ¯
    Message msg;
    memset(&msg, 0, sizeof(msg));
    msg.type = MSG_CHAT;
    strncpy(msg.sender, username, NAME_SIZE - 1);
    
    char input_buffer[BUFFER_SIZE];
    
    while (1) {
        printf("%s> ", username);
        fflush(stdout);
        
        if (fgets(input_buffer, sizeof(input_buffer), stdin) == NULL) {
            printf("\nè¯»å–è¾“å…¥å¤±è´¥ï¼Œé€€å‡ºç¨‹åº\n");
            break;
        }
        
        // ç§»é™¤æ¢è¡Œç¬¦
        input_buffer[strcspn(input_buffer, "\n")] = '\0';
        
        // æ£€æŸ¥é€€å‡ºå‘½ä»¤
        if (strcmp(input_buffer, "quit") == 0 || strcmp(input_buffer, "exit") == 0) {
            printf("æ­£åœ¨é€€å‡º...\n");
            msg.type = MSG_LOGOUT;
            strncpy(msg.content, "ç”¨æˆ·ä¸»åŠ¨é€€å‡º", BUFFER_SIZE - 1);
            send(client_socket, (char*)&msg, sizeof(Message), 0);
            break;
        }
        
        // æ£€æŸ¥å¸®åŠ©å‘½ä»¤
        if (strcmp(input_buffer, "help") == 0) {
            printf("\n=== å¸®åŠ©ä¿¡æ¯ ===\n");
            printf("quit/exit - é€€å‡ºç¨‹åº\n");
            printf("help      - æ˜¾ç¤ºæ­¤å¸®åŠ©\n");
            printf("å…¶ä»–è¾“å…¥  - å‘é€èŠå¤©æ¶ˆæ¯\n");
            printf("===============\n\n");
            continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæ¶ˆæ¯
        if (strlen(input_buffer) == 0) {
            continue;
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        msg.type = MSG_CHAT;
        strncpy(msg.content, input_buffer, BUFFER_SIZE - 1);
        strncpy(msg.timestamp, get_current_time(), 31);
        
        if (send(client_socket, (char*)&msg, sizeof(Message), 0) == SOCKET_ERROR) {
            printf("âŒ å‘é€æ¶ˆæ¯å¤±è´¥: %d\n", WSAGetLastError());
            printf("ä¸æœåŠ¡å™¨çš„è¿æ¥å¯èƒ½å·²æ–­å¼€\n");
            break;
        }
    }
    
    // ç­‰å¾…æ¥æ”¶çº¿ç¨‹ç»“æŸ
    printf("ç­‰å¾…æ¥æ”¶çº¿ç¨‹ç»“æŸ...\n");
    WaitForSingleObject(recv_thread, 3000);  // ç­‰å¾…3ç§’
    CloseHandle(recv_thread);
    
    // æ¸…ç†èµ„æº
    closesocket(client_socket);
    cleanup_winsock();
    
    printf("âœ“ å·²æ–­å¼€è¿æ¥ï¼Œå†è§ï¼\n");
    system("pause");
    return 0;
}

DWORD WINAPI receive_messages(LPVOID client_socket) {
    SOCKET sock = (SOCKET)client_socket;
    Message msg;
    
    printf("âœ“ æ¶ˆæ¯æ¥æ”¶çº¿ç¨‹å¯åŠ¨\n");
    
    while (1) {
        int bytes_received = recv(sock, (char*)&msg, sizeof(Message), 0);
        if (bytes_received <= 0) {
            if (bytes_received == 0) {
                printf("\nğŸ“¢ æœåŠ¡å™¨å…³é—­äº†è¿æ¥\n");
            } else {
                printf("\nâŒ æ¥æ”¶æ¶ˆæ¯å¤±è´¥: %d\n", WSAGetLastError());
            }
            break;
        }
        
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
        switch (msg.type) {
            case MSG_CHAT:
                if (strcmp(msg.sender, "ç³»ç»Ÿ") == 0) {
                    printf("\nğŸ“¢ [ç³»ç»Ÿæ¶ˆæ¯] %s\n", msg.content);
                } else {
                    printf("\nğŸ’¬ [%s] %s: %s\n", msg.timestamp, msg.sender, msg.content);
                }
                break;
                
            case MSG_USER_LIST:
                printf("\nğŸ‘¥ åœ¨çº¿ç”¨æˆ·: %s\n", msg.content);
                break;
                
            default:
                printf("\nâ“ æ”¶åˆ°æœªçŸ¥ç±»å‹æ¶ˆæ¯\n");
                break;
        }
        
        // é‡æ–°æ˜¾ç¤ºè¾“å…¥æç¤ºç¬¦ (å› ä¸ºæ— æ³•è·å–ç”¨æˆ·åï¼Œä½¿ç”¨ç®€å•æç¤ºç¬¦)
        printf("> ");
        fflush(stdout);
    }
    
    printf("æ¶ˆæ¯æ¥æ”¶çº¿ç¨‹ç»“æŸ\n");
    return 0;
}
